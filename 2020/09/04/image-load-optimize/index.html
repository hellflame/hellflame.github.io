<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><title>博客图片加载优化 | Hellflame</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="basics,web,javascript,"><meta name="description" content="pleased or sad, everything dies with hellflame"><link rel="alternate" href="/atom.xml" title="Hellflame" type="application/atom+xml"><link rel="icon" href="/images/favicon.png"><link rel="apple-touch-icon" href="/images/favicon.png"><link href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.6/dist/jquery.fancybox.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/base.css"><link rel="stylesheet" href="/icon/iconfont.css"><link rel="stylesheet" href="/css/github-markdown.css"><link rel="stylesheet" href="/css/highlight.css"><script src="/js/util.js"></script><script src="/js/valine.min.js"></script><link href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js" async></script><script src="/js/player.js"></script><link href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/leancloud-storage@3.11.0/dist/av-min.js"></script></head><body><div id="app"><div class="header-wrap"><header><div class="site-brand"><div class="site-title"> <a href="/">Hellflame</a></div></div><nav class="site-navigation"><ul class="nav-menu"><li class="nav-item" data-path="/"> <a href="/" target="_self">首页</a></li><li class="nav-item" data-path="/archives/"> <a href="/archives/" target="_self">归档</a></li><li class="nav-item" data-path="/categories/"> <a href="/categories/" target="_self">分类</a></li><li class="nav-item" data-path="/tags/"> <a href="/tags/" target="_self">标签</a></li><li class="nav-item" data-path="/friends/"> <a href="/friends/" target="_self">友链</a></li><li class="nav-item" data-path="/about/"> <a href="/about/" target="_self">关于</a></li><li class="nav-item" data-path="https://github.com/hellflame"> <a href="https://github.com/hellflame" target="_self">Github</a></li></ul></nav><i class="iconfont icon-menu"></i></header></div><script src="/js/navigation.js"></script><div class="container post-index"><div class="post"><div style="position:fixed;right:1em;top:1.5em;cursor:pointer;z-index:999" onclick="toggleTOC()" id="toc"><div style="width:2em;height:2em"><div style="width:100%;height:3px;background:silver;margin-bottom:3px"></div><div style="width:100%;height:3px;background:silver;margin-bottom:3px"></div><div style="width:100%;height:3px;background:silver;margin-bottom:3px"></div></div></div><h1 class="article-title"> <span>博客图片加载优化</span></h1><div class="article-top-meta"> <span>发布 : 2020-09-04</span> <span>分类 : <a href="/categories/basics/">basics</a></span> <span>浏览 : <span class="article-timer">--</span></span></div><div class="article-content"><div class="markdown-body"><p>所谓“一站式”，大概是所有图片资源都在 <code>github.io</code> 一个站点，国内访问相关地址时一般都会十分缓慢，如果再把超大的图片放上去，不用代理的话，大概只能在不繁忙的凌晨能够加载出图片，平时应该什么图片都加载不出来，因为所有图片几乎都是同时请求资源，但是谁都没有请求完就都超时了</p><p>这里所谓的“解决”，其实并不能解决图片加载慢的问题，真正要解决大概只有通过CDN或者其他更快节点的图片节点才能解决。这里只是能够尽最大努力一张图片一张图片的加载</p><p>由于整个网站都是通过 <code>hexo</code> 生成完整的静态网站，所以第一步要做的，是在翻译markdown时将 <code>img</code> 标签的 <code>src</code> 属性置为无效，但又要能够在访问时恢复成正确的地址</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">page.more.replace(<span class="regexp">/\.webp-/igm</span>, <span class="string">".webp-"</span>)</span><br></pre></td></tr></table></figure><p>这里做了两件事情，首先是将原始的 <code>jpg</code> 文件后缀替换为 <code>webp</code> ，使得在支持 webp 的浏览器上使用更小的资源，当然，这个webp图片是在生成静态网站时生成的；然后是在替换后缀时，添加了一个 <code>-</code> ，这样这个图片就一定是 <code>404</code> 了，这样图片的响应时间就会和响应 <code>404</code> 的时间一致的短了。更理想的情况应该是把 <code>src</code> 属性完全移除，添加一个类似 <code>data-src</code> 的属性，这样图片甚至都不会去尝试请求 <code>404</code> 地址，不过这里为了简单方便，就用了这种替代方式</p><p>最后，在访问时，需要将无效的地址替换为有效地址，重要的是依次替换，并且在上一张图片加载成功之后，下一张图片再继续加载</p><p>这里在原本蹩脚的 <code>js</code> 代码里，又添加了蹩脚的代码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replaceImg</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> browser = getBrowser()</span><br><span class="line">  <span class="keyword">const</span> supportWebp = browser === <span class="string">"FireFox"</span> || browser === <span class="string">"Chrome"</span> <span class="comment">// 判断是否支持 webp</span></span><br><span class="line">  <span class="keyword">const</span> images = $(<span class="string">".post img"</span>) <span class="comment">// 获取所有img标签</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; images.length; i ++) &#123;</span><br><span class="line">    <span class="keyword">const</span> target = $(images[i])</span><br><span class="line">    <span class="keyword">if</span> (target.parent().get(<span class="number">0</span>).tagName.toLowerCase() === <span class="string">'a'</span>) &#123;</span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> originSrc = target.attr(<span class="string">'src'</span>)</span><br><span class="line">    <span class="keyword">if</span> (originSrc.slice(<span class="number">-1</span>)[<span class="number">0</span>] !== <span class="string">'-'</span>) &#123;</span><br><span class="line">      <span class="comment">// 判断如果已经替换过，则跳过</span></span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> realSrc = originSrc.slice(<span class="number">0</span>, <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">const</span> wrapper = <span class="built_in">document</span>.createElement(<span class="string">'a'</span>)</span><br><span class="line">    <span class="keyword">const</span> jpgSrc = realSrc.slice(<span class="number">0</span>, realSrc.indexOf(<span class="string">".webp"</span>)) + <span class="string">".webp-"</span></span><br><span class="line">    $(wrapper).attr(<span class="string">"data-fancybox"</span>, <span class="string">"gallery"</span>) <span class="comment">// 添加fancybox支持</span></span><br><span class="line">    <span class="keyword">if</span> (supportWebp) &#123;</span><br><span class="line">      <span class="comment">// 如果支持 webp</span></span><br><span class="line">      target.attr(<span class="string">'src'</span>, realSrc)</span><br><span class="line">      $(wrapper).attr(<span class="string">"href"</span>, realSrc)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 不支持webp</span></span><br><span class="line">      target.attr(<span class="string">'src'</span>, jpgSrc)</span><br><span class="line">      $(wrapper).attr(<span class="string">"href"</span>, jpgSrc)</span><br><span class="line">    &#125;</span><br><span class="line">    images[i].onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 在当前这张图片加载完之后，再次执行 replaceImg</span></span><br><span class="line">      replaceImg()</span><br><span class="line">    &#125;</span><br><span class="line">    target.wrap(wrapper)</span><br><span class="line">    <span class="keyword">break</span> <span class="comment">// 成功替换一次之后，立即结束循环</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>添加执行时机</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  replaceImg()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>整个过程采用了类似递归的形式触发下一张图片的加载，好处在于整个页面内的所有图片都会从上到下一张一张的加载，即使网速很慢，现在也会使用全部的带宽资源加载一张图片，如果依然无法加载出来，，，那说明真的不行，这个时候可以设计图片的 <code>onerror</code> 事件，决定是否要尝试下一张或者重试</p><p>嗯，，只想做一站式的人大概就只能想出这种节约资源的方式了=。=</p></div></div><div class="copy-right"><div class="markdown-body"><blockquote> 本文作者 : hellflame<br> 原文链接 : <a href="">https://hellflame.github.io/2020/09/04/image-load-optimize/</a><br> 版权声明 : 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</blockquote></div></div><div class="social-share" style="margin-top:-2rem" data-wechat-qrcode-title="<p>微信扫一扫</p>" data-wechat-qrcode-helper="<p>微信右上角, 扫一扫分享</p>" data-sites="qzone, qq, weibo, facebook, twitter"> <span style="color:#6b7487;font-size:1.4rem">分享到:</span></div><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js" async></script><div class="article-footer"><div class="article-meta pull-left"><span><i class="iconfont icon-06tags"></i> 标签: <span class="span--tag"><a href="/tags/web/">#web</a></span> <span class="span--tag"><a href="/tags/javascript/">#javascript</a></span></span></div><div class="article-meta pull-right"></div></div></div><aside id="sidebar"><p id="sidebar-header"></p><ol id="sidebar-toc"></ol></aside><script async>getTOC().length||$("#toc").remove()</script><nav class="post-navigation"><div class="nav-pre"><i class="iconfont icon-prev"></i> 上一篇: <a href="/2020/09/02/sun-rise/" target="_self">海边日出</a></div><div class="nav-next"> 下一篇: <a href="/2020/09/06/meal-on-gouqi-island/" target="_self">枸杞岛大餐</a><i class="iconfont icon-next"></i></div></nav><a href="#comment" class="comment-anchor"></a><div class="comment-title"><i class="iconfont icon-footprint"></i> 留下足迹<i class="iconfont icon-footprint"></i></div> <a style="margin-bottom:1em;display:block;cursor:pointer" onclick="gotoComment()">点击通过issue留言</a><div id="vcomments"></div><script defer="defer">new Valine({el:"#vcomments",appId:"a",appKey:"b",notify:!1,verify:!1,avatar:"robohash",placeholder:"不填邮箱，网址, 也能收到回复哦♪(^∇^*)\n当然也不一定会回复-_-",path:getRealPath()})</script><script defer="defer">
   function gotoComment() {
    location.href = `https://github.com/hellflame/hellflame.github.io/issues/new?title=关于%0A“%E5%8D%9A%E5%AE%A2%E5%9B%BE%E7%89%87%E5%8A%A0%E8%BD%BD%E4%BC%98%E5%8C%96”&body=%23%23%23%20[原文地址](https://hellflame.github.io/2020/09/04/image-load-optimize/)%0A%0A%23%23%23%20想说的话(问题/支持/异议)%20%20%0A%0A${document.getElementById('veditor').value}`
   }
   document.onreadystatechange = (e) => {
     if(document.readyState === 'complete') {
      setTimeout(() => {
        const target = document.getElementsByClassName("vsubmit vbtn")[0]
        target.outerHTML = target.outerHTML
        setTimeout(() => {
          document.getElementsByClassName("vsubmit vbtn")[0].addEventListener('click', gotoComment)
          console.log("event replaced")
        }, 1000)
        document.getElementsByClassName("power txt-right")[0].innerHTML = "Once powered by Valine"
      }, 1000)
     }
   }
 </script></div><footer><p class="site-info"> 博客已萌萌哒运行<span id="time-to-now"></span><span class="my-face">(●'◡'●)ﾉ♥</span><br> Theme - <a target="_blank" href="https://github.com/dongyuanxin/theme-bmw">BMW</a> | Made With 💗 | Powered by GodBMW & hellflame<br></p></footer><script src="/js/footer.js"></script><script>updateUptime(2016,3,27)</script><div class="back-to-top hidden"><span><i class="iconfont icon-60"></i><span></span> %</span></div><script src="/js/component/back-to-top.js"></script></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script src="/js/mathjax.js"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.6/dist/jquery.fancybox.min.js" async></script><script async src="/js/fancybox.js"></script></body></html>