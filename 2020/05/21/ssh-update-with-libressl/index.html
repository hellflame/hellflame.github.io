<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><title>libressl + ssh 编译安装 | Hellflame</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="basics,"><meta name="description" content="pleased or sad, everything dies with hellflame"><link rel="alternate" href="/atom.xml" title="Hellflame" type="application/atom+xml"><link rel="icon" href="/images/favicon.png"><link rel="apple-touch-icon" href="/images/favicon.png"><link href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.6/dist/jquery.fancybox.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/base.css"><link rel="stylesheet" href="/icon/iconfont.css"><link rel="stylesheet" href="/css/github-markdown.css"><link rel="stylesheet" href="/css/highlight.css"><script src="/js/util.js"></script><script src="/js/valine.min.js"></script><link href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js" async></script><script src="/js/player.js"></script><link href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/leancloud-storage@3.11.0/dist/av-min.js"></script></head><body><div id="app"><div class="header-wrap"><header><div class="site-brand"><div class="site-title"> <a href="/">Hellflame</a></div></div><nav class="site-navigation"><ul class="nav-menu"><li class="nav-item" data-path="/"> <a href="/" target="_self">首页</a></li><li class="nav-item" data-path="/archives/"> <a href="/archives/" target="_self">归档</a></li><li class="nav-item" data-path="/categories/"> <a href="/categories/" target="_self">分类</a></li><li class="nav-item" data-path="/tags/"> <a href="/tags/" target="_self">标签</a></li><li class="nav-item" data-path="/friends/"> <a href="/friends/" target="_self">友链</a></li><li class="nav-item" data-path="/corner-story/"> <a href="/corner-story/" target="_self">转角杀</a></li><li class="nav-item" data-path="/about/"> <a href="/about/" target="_self">关于</a></li><li class="nav-item" data-path="https://github.com/hellflame"> <a href="https://github.com/hellflame" target="_self">Github</a></li></ul></nav><i class="iconfont icon-menu"></i></header></div><script src="/js/navigation.js"></script><div class="container post-index"><div class="post"><div style="position:fixed;right:1em;top:1.5em;cursor:pointer;z-index:999" onclick="toggleTOC()" id="toc"><div style="width:2em;height:2em"><div style="width:100%;height:3px;background:silver;margin-bottom:3px"></div><div style="width:100%;height:3px;background:silver;margin-bottom:3px"></div><div style="width:100%;height:3px;background:silver;margin-bottom:3px"></div></div></div><h1 class="article-title"> <span>libressl + ssh 编译安装</span></h1><div class="article-top-meta"> <span>发布 : 2020-05-21</span> <span>分类 : <a href="/categories/basics/">basics</a></span> <span>浏览 : <span class="article-timer">--</span></span></div><div class="article-content"><div class="markdown-body"><p>总之，在不破坏原操作系统 <code>openssl</code> + <code>openssh</code> ，并且没有外网支持的情况下，在 <code>debian</code> 中正常安装了 <code>libressl</code> + <code>openssh</code> 的组合，网上给出的大多数方案是直接替换原本的 <code>ssh</code> 服务，不过如果操作不当，会导致 <code>ssh</code> 无法使用，视情况，后果可能很麻烦，所以这里不会影响原 <code>ssh</code> 服务</p><p>首先，需要有一台能够正常联网使用的 <code>debian</code> ，才能编译好 <code>libressl</code> 和 <code>openssh</code> ，目标服务器能做的就只是接收拷贝的文件了，所以这里需要在外网编译安装的位置，就是目标服务器上的安装位置</p><h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><p>在 <code>libressl</code> 官网下载 <a href="https://ftp.openbsd.org/pub/OpenBSD/LibreSSL/" target="_blank" rel="noopener">libressl</a> ，比如 <code>libressl-3.1.2.tar.gz</code></p><p>在 <code>openssh</code> 官网下载 <a href="https://www.openssh.com/portable.html" target="_blank" rel="noopener">openssh</a> ，比如这里的 <code>openssh-8.2p1</code></p><h4 id="编译安装-libressl"><a href="#编译安装-libressl" class="headerlink" title="编译安装 libressl"></a>编译安装 libressl</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tar -xf libressl-3.1.2.tar.gz</span><br><span class="line"><span class="built_in">cd</span> libressl-3.1.2</span><br><span class="line">./configure --prefix=/opt/libressl  <span class="comment"># 一般习惯把用户软件安装在 /opt, 这也是为了方便移植</span></span><br><span class="line">make -j4  <span class="comment"># 这个过程会比较长</span></span><br><span class="line">make check</span><br><span class="line">sudo make install  <span class="comment"># sudo 主要是 /opt 一般普通用户没权限</span></span><br></pre></td></tr></table></figure><p><strong>新增动态库配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root</span></span><br><span class="line"><span class="built_in">echo</span> /opt/libressl/lib &gt; /etc/ld.so.conf.d/libressl.conf  <span class="comment"># 重要</span></span><br><span class="line">ldconfig</span><br></pre></td></tr></table></figure><p>文件名不重要，关键在于 <code>/etc/ld.so.conf.d/</code> 目录下创建 <code>.conf</code> 文件，并写下 <code>/opt/libressl/lib</code> 添加到动态库搜索路径中，<code>ldconfig</code> 让该配置生效，这一步不仅需要在当前机器上操作，最终也需要在目标服务器上操作</p><h4 id="编译安装-openssh"><a href="#编译安装-openssh" class="headerlink" title="编译安装 openssh"></a>编译安装 openssh</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -xf openssh-8.2p1.tar.gz</span><br><span class="line"><span class="built_in">cd</span> openssh-8.2p1</span><br><span class="line">./configure --prefix=/opt/ssh --with-ssl-dir=/opt/libressl  <span class="comment"># 指定ssh安装路径，以及libressl路径</span></span><br></pre></td></tr></table></figure><p>configure 之后，正常情况下应该有类似下面的输出</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">              Host: x86_64-pc-linux-gnu</span><br><span class="line">          Compiler: cc</span><br><span class="line">    Compiler flags: -g -O2 -pipe -Wno-error=format-truncation -Wall -Wpointer-arith -Wuninitialized -Wsign-compare -Wformat-security -Wsizeof-pointer-memaccess -Wno-pointer-sign -Wno-unused-result -Wimplicit-fallthrough -fno-strict-aliasing -D_FORTIFY_SOURCE=2 -ftrapv -fno-builtin-memset -fstack-protector-strong -fPIE</span><br><span class="line">Preprocessor flags: -I/opt/libressl/include  -D_XOPEN_SOURCE=600 -D_BSD_SOURCE -D_DEFAULT_SOURCE</span><br><span class="line">      Linker flags: -L/opt/libressl/lib  -Wl,-z,relro -Wl,-z,now -Wl,-z,noexecstack -fstack-protector-strong -pie</span><br><span class="line">         Libraries: -lcrypto -ldl -lutil -lz  -lcrypt -lresolv</span><br></pre></td></tr></table></figure><p>如果这一步有关于 <code>ssl</code> 相关的错误报出的话，需要检查动态库配置是否有问题，曾经在这里徘徊了很久=。=</p><p>如果没有问题就可以继续了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make -j4</span><br><span class="line">make tests  <span class="comment"># 时间比较久，不过应该是值得的</span></span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure><p>安装过程基本上就结束了，接下来需要配置 <code>ssh</code> 在别的端口启动</p><p><code>/opt/ssh/etc/sshd_config</code> 修改端口为 <code>23</code> (不与服务器当前ssh端口相同即可)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Port 23</span><br></pre></td></tr></table></figure><h4 id="验证安装结果"><a href="#验证安装结果" class="headerlink" title="验证安装结果"></a>验证安装结果</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /opt/ssh/sbin/sshd  <span class="comment"># 需要超级用户权限，并且使用绝对路径</span></span><br></pre></td></tr></table></figure><p>尝试本机登录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 23 hellflame@localhost</span><br></pre></td></tr></table></figure><p>输入密码，理论上能够正常登录即可</p><h4 id="移植"><a href="#移植" class="headerlink" title="移植"></a>移植</h4><p>将两个安装目录打包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tar -cvf ssh.tar /opt/libressl /opt/ssh</span><br></pre></td></tr></table></figure><p>将 <code>ssh.tar</code> 拷贝至目标服务器，恢复 <code>libressl</code> , <code>ssh</code> 至 <code>/opt</code> 目录</p><p><strong>更新动态库配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root</span></span><br><span class="line"><span class="built_in">echo</span> /opt/libressl/lib &gt; /etc/ld.so.conf.d/libressl.conf  <span class="comment"># 重要</span></span><br><span class="line">ldconfig</span><br></pre></td></tr></table></figure><p>动作和之前相同</p><p>启动 <code>sshd</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /var/empty  <span class="comment"># 大概率需要创建这个目录，然后再启动</span></span><br><span class="line"></span><br><span class="line">/opt/ssh/sbin/sshd</span><br></pre></td></tr></table></figure><p>剩下验证一下新的ssh实例是否可以正常使用</p><h4 id="替换原ssh"><a href="#替换原ssh" class="headerlink" title="替换原ssh"></a>替换原ssh</h4><p><strong>这一步相对比较危险，搞不好重启之后就无法登录服务器了</strong></p><p>此时其实新旧两个版本的ssh都可以正常运行，不一样的是原ssh还有默认的启动脚本支持，所以这里其实只需要先通过新版ssh端口登陆到服务器，更新启动脚本 <code>/etc/init.d/ssh</code> 即可</p><p>主要需要更新其中的 <code>ssh配置位置</code>，<code>可执行文件路径</code> ，不过我实际上并没有操作这一步，而只是简单的关闭了旧ssh服务，这是出于几个考虑</p><ol><li>防止重启之后新版sshd启动失败，而旧版sshd已经没有启动入口，导致无法登录服务器</li><li>如果新版sshd由于误操作崩溃，硬重启服务器之后还有旧版服务可以自动启动</li><li>服务器不可登录风险低</li></ol><p>毕竟只要正常使用新端口的ssh服务即可，客户端的默认配置可以通过 <code>$HOME/.ssh/config</code> 文件控制端口使用</p><p>当然，走过这一步也没问题，至少以后重启服务器之后都能使用新版本的ssh服务</p><h4 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h4><p>这里在编译 <code>libressl</code> 和 <code>openssh</code> 的时候都仅展示使用了最简单的配置，或者说移植编译安装中最核心的配置，实际情况中需要根据需要，添加编译参数，当然可能也会带来新的库的安装，这些就要靠每个人自由发挥了</p></div></div><div class="copy-right"><div class="markdown-body"><blockquote> 本文作者 : hellflame<br> 原文链接 : <a href="">https://hellflame.github.io/2020/05/21/ssh-update-with-libressl/</a><br> 版权声明 : 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</blockquote></div></div><div class="social-share" style="margin-top:-2rem" data-wechat-qrcode-title="<p>微信扫一扫</p>" data-wechat-qrcode-helper="<p>微信右上角, 扫一扫分享</p>" data-sites="qzone, qq, weibo, facebook, twitter"> <span style="color:#6b7487;font-size:1.4rem">分享到:</span></div><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js" async></script><div class="article-footer"><div class="article-meta pull-left"><span></span></div><div class="article-meta pull-right"></div></div></div><aside id="sidebar"><p id="sidebar-header"></p><ol id="sidebar-toc"></ol></aside><script async>getTOC().length||$("#toc").remove()</script><nav class="post-navigation"><div class="nav-pre"><i class="iconfont icon-prev"></i> 上一篇: <a href="/2020/05/17/music-starter/" target="_self">开启音乐之路</a></div><div class="nav-next"> 下一篇: <a href="/2020/06/01/summer-nioi/" target="_self">夏天的味道</a><i class="iconfont icon-next"></i></div></nav><a href="#comment" class="comment-anchor"></a><div class="comment-title"><i class="iconfont icon-footprint"></i> 留下足迹<i class="iconfont icon-footprint"></i></div> <a style="margin-bottom:1em;display:block;cursor:pointer" onclick="gotoComment()">点击通过issue留言</a><div id="vcomments"></div><script defer="defer">new Valine({el:"#vcomments",appId:"a",appKey:"b",notify:!1,verify:!1,avatar:"robohash",placeholder:"不填邮箱，网址, 也能收到回复哦♪(^∇^*)\n当然也不一定会回复-_-",path:getRealPath()})</script><script defer="defer">
   function gotoComment() {
    location.href = `https://github.com/hellflame/hellflame.github.io/issues/new?title=关于%0A“libressl%20%2B%20ssh%20%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85”&body=%23%23%23%20[原文地址](https://hellflame.github.io/2020/05/21/ssh-update-with-libressl/)%0A%0A%23%23%23%20想说的话(问题/支持/异议)%20%20%0A%0A${document.getElementById('veditor').value}`
   }
   document.onreadystatechange = (e) => {
     if(document.readyState === 'complete') {
      setTimeout(() => {
        const target = document.getElementsByClassName("vsubmit vbtn")[0]
        target.outerHTML = target.outerHTML
        setTimeout(() => {
          document.getElementsByClassName("vsubmit vbtn")[0].addEventListener('click', gotoComment)
          console.log("event replaced")
        }, 1000)
        document.getElementsByClassName("power txt-right")[0].innerHTML = "Once powered by Valine"
      }, 1000)
     }
   }
 </script></div><footer><p class="site-info"> 博客已萌萌哒运行<span id="time-to-now"></span><span class="my-face">(●'◡'●)ﾉ♥</span><br> Theme - <a target="_blank" href="https://github.com/dongyuanxin/theme-bmw">BMW</a> | Made With 💗 | Powered by GodBMW & hellflame<br></p></footer><script src="/js/footer.js"></script><script>updateUptime(2016,3,27)</script><div class="back-to-top hidden"><span><i class="iconfont icon-60"></i><span></span> %</span></div><script src="/js/component/back-to-top.js"></script></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script src="/js/mathjax.js"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.6/dist/jquery.fancybox.min.js" async></script><script async src="/js/fancybox.js"></script></body></html>