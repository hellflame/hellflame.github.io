<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><title>Nginx部署中关于Flask的错误优化 | Hellflame</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="diaries,python,nginx,"><meta name="description" content="pleased or sad, everything dies with hellflame"><link rel="alternate" href="/atom.xml" title="Hellflame" type="application/atom+xml"><link rel="icon" href="/images/favicon.png"><link rel="apple-touch-icon" href="/images/favicon.png"><link href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.6/dist/jquery.fancybox.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/base.css"><link rel="stylesheet" href="/icon/iconfont.css"><link rel="stylesheet" href="/css/github-markdown.css"><link rel="stylesheet" href="/css/highlight.css"><script src="/js/util.js"></script><script src="/js/valine.min.js"></script><link href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js" async></script><script src="/js/player.js"></script><link href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/leancloud-storage@3.11.0/dist/av-min.js"></script></head><body><div id="app"><div class="header-wrap"><header><div class="site-brand"><div class="site-title"> <a href="/">Hellflame</a></div></div><nav class="site-navigation"><ul class="nav-menu"><li class="nav-item" data-path="/"> <a href="/" target="_self">首页</a></li><li class="nav-item" data-path="/archives/"> <a href="/archives/" target="_self">归档</a></li><li class="nav-item" data-path="/categories/"> <a href="/categories/" target="_self">分类</a></li><li class="nav-item" data-path="/tags/"> <a href="/tags/" target="_self">标签</a></li><li class="nav-item" data-path="/friends/"> <a href="/friends/" target="_self">友链</a></li><li class="nav-item" data-path="/corner-story/"> <a href="/corner-story/" target="_self">转角杀</a></li><li class="nav-item" data-path="/about/"> <a href="/about/" target="_self">关于</a></li><li class="nav-item" data-path="https://github.com/hellflame"> <a href="https://github.com/hellflame" target="_self">Github</a></li></ul></nav><i class="iconfont icon-menu"></i></header></div><script src="/js/navigation.js"></script><div class="container post-index"><div class="post"><div style="position:fixed;right:1em;top:1.5em;cursor:pointer;z-index:999" onclick="toggleTOC()" id="toc"><div style="width:2em;height:2em"><div style="width:100%;height:3px;background:silver;margin-bottom:3px"></div><div style="width:100%;height:3px;background:silver;margin-bottom:3px"></div><div style="width:100%;height:3px;background:silver;margin-bottom:3px"></div></div></div><h1 class="article-title"> <span>Nginx部署中关于Flask的错误优化</span></h1><div class="article-top-meta"> <span>发布 : 2016-07-19</span> <span>分类 : <a href="/categories/diaries/">diaries</a></span> <span>浏览 : <span class="article-timer">--</span></span></div><div class="article-content"><div class="markdown-body"><h4 id="蜜汁404"><a href="#蜜汁404" class="headerlink" title="蜜汁404"></a>蜜汁404</h4><p>好吧，虽然已经快去实习了，然而也貌似累积了不少网站在手上，果然还是平时玩的太多了，我需要认真的反思了</p><p>就在刚刚做<a href="http://zzgl.hellflame.net" target="_blank" rel="noopener">资助管理网</a>的旧网站数据兼容的时候发现了一个相当奇怪的地方，好吧，其实也不算奇怪，不就是在自己笔记本上怎么测试都运行的各种完美，到了服务器上就死活找不到原因。</p><p><img src="https://static.hellflame.net/resource/e3880497bc606e012989f2ee8d379e7b" alt="zzgl图片资源"></p><p>以上图片一直加载显示<code>404</code>，蜜汁<code>404</code>，让喵抓狂了好久，无论怎么修改代码都无法在服务器上正常运行。让我一直以为是flask的redirect有问题或者是浏览器对于这样直接显示的图片资源进行重定向就会出现这样的问题。</p><p>当然这样只有在服务器上才会出现的问题，当然Nginx的日志显得尤为重要了。</p><p><img src="https://static.hellflame.net/resource/82800e32df9234da4347f2a04767e743" alt="蜜汁Nginx报错"></p><p><code>No such file or directory</code>!!!</p><p>好吧，的确，图片并不在这个目录，然而，我确实在代码中重定向了啊！！！不然我本地不早就报错了么，，，不可能，一定是服务器上有鬼作祟，，恩，一定是酱紫的。。。。</p><h4 id="柳暗花明"><a href="#柳暗花明" class="headerlink" title="柳暗花明"></a>柳暗花明</h4><p>就在快放弃治疗的时候，想起来服务器上Nginx的标准配置，当年韬肾配置好了第一个news的模板，后来所有人都copy这份代码，好吧，虽然后来自己有简化过Nginx配置文件中的变量设置，不过大体并没有改变。</p><p>其中有一段优化静态文件的配置如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|ttf|woff)$ &#123;</span><br><span class="line">                expires      30d;</span><br><span class="line">        &#125;</span><br><span class="line">location ~ .*\.(js|css)?$ &#123;</span><br><span class="line">                expires      12h;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>原本的意思是缓存下所有的图片，动画，字体资源等(缓存30天)，缓存<code>js</code>和<code>css</code>文件12小时。不得不说，这样的配置，对于原本的需求来说是很合理的，程序员并不会编辑图片资源或者其他媒体资源(除非程序员兼职设计。。。)，所以缓存下来会加快第二次访问的速度，然而<code>location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|ttf|woff)$</code>这句话包含的范围太广了诶，由于在这里的Nginx作为最高级的代理，会先把符合规则的url拦截下来，在这里看上去只是在header里面添加了<code>expires</code>的选项然后再返回给<code>uwsgi</code>，<code>uwsgi</code>再到<code>flask</code>应用。</p><p>个人猜测，Nginx在获取到符合这条规则的时候会拦截这条URL，并直接作为静态文件返回，不会向下发送给<code>uwsgi</code>甚至<code>flask</code></p><p>作为重定向访问，正确的结果如下：</p><p><img src="https://static.hellflame.net/resource/515ec2bf02347417ab279fb04112e391" alt="正常重定向"></p><p>突然想起来，还好我在做静态文件服务器的时候用的是没有任何后缀的hash值来索引一个文件，如果在不知道还有这样的情况存在的话，可能这篇文章早就出来了233333</p><p>其实对于默认静态文件目录配置的flask来说，应该在这个url规则中限制static下的文件才进行缓存就好了的，like this <code>location ~* /static/.*\.(gif|jpg|jpeg|png|bmp|swf|ttf|woff)$ { expires 30d; }</code>，应该就差不多了～～</p><h4 id="最后纪念"><a href="#最后纪念" class="headerlink" title="最后纪念"></a>最后纪念</h4><p>最后，纪念一下即将迁移的服务器，传输了我的服务器一年都传输不了的数据量</p><p><img src="https://static.hellflame.net/resource/3f39100dde241c09f799e24e246603a8" alt="炒鸡多的流量传输"></p><p>好吧，毕竟也运行了好久了的服务器捏～～～</p><blockquote><p>18:19:55 up 303 days, 18:12, 1 user, load average: 0.21, 0.05, 0.01</p></blockquote></div></div><div class="copy-right"><div class="markdown-body"><blockquote> 本文作者 : hellflame<br> 原文链接 : <a href="">https://hellflame.github.io/2016/07/19/nginx-flask-deploy-failure-check/</a><br> 版权声明 : 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</blockquote></div></div><div class="social-share" style="margin-top:-2rem" data-wechat-qrcode-title="<p>微信扫一扫</p>" data-wechat-qrcode-helper="<p>微信右上角, 扫一扫分享</p>" data-sites="qzone, qq, weibo, facebook, twitter"> <span style="color:#6b7487;font-size:1.4rem">分享到:</span></div><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js" async></script><div class="article-footer"><div class="article-meta pull-left"><span><i class="iconfont icon-06tags"></i> 标签: <span class="span--tag"><a href="/tags/python/">#python</a></span> <span class="span--tag"><a href="/tags/nginx/">#nginx</a></span></span></div><div class="article-meta pull-right"></div></div></div><aside id="sidebar"><p id="sidebar-header"></p><ol id="sidebar-toc"></ol></aside><script async>getTOC().length||$("#toc").remove()</script><nav class="post-navigation"><div class="nav-pre"><i class="iconfont icon-prev"></i> 上一篇: <a href="/2016/07/03/end-of-college/" target="_self">致即将结束的大学</a></div><div class="nav-next"> 下一篇: <a href="/2016/07/25/want-to-do-more/" target="_self">I Want to build more</a><i class="iconfont icon-next"></i></div></nav><a href="#comment" class="comment-anchor"></a><div class="comment-title"><i class="iconfont icon-footprint"></i> 留下足迹<i class="iconfont icon-footprint"></i></div> <a style="margin-bottom:1em;display:block;cursor:pointer" onclick="gotoComment()">通过issue留言</a><div id="vcomments"></div><script defer="defer">new Valine({el:"#vcomments",appId:"a",appKey:"b",notify:!1,verify:!1,avatar:"robohash",placeholder:"不填邮箱，网址, 也能收到回复哦♪(^∇^*)\n当然也不一定会回复-_-",path:getRealPath()})</script><script defer="defer">
   function gotoComment() {
    location.href = `https://github.com/hellflame/hellflame.github.io/issues/new?title=关于%0A“Nginx%E9%83%A8%E7%BD%B2%E4%B8%AD%E5%85%B3%E4%BA%8EFlask%E7%9A%84%E9%94%99%E8%AF%AF%E4%BC%98%E5%8C%96”&body=%23%23%23%20[原文地址](https://hellflame.github.io/2016/07/19/nginx-flask-deploy-failure-check/)%0A%0A%23%23%23%20想说的话(问题/支持/异议)%20%20%0A%0A${document.getElementById('veditor').value}`
   }
   document.onreadystatechange = (e) => {
     if(document.readyState === 'complete') {
      setTimeout(() => {
        const target = document.getElementsByClassName("vsubmit vbtn")[0]
        target.outerHTML = target.outerHTML
        setTimeout(() => {
          document.getElementsByClassName("vsubmit vbtn")[0].addEventListener('click', gotoComment)
          console.log("event replaced")
        }, 1000)
        document.getElementsByClassName("power txt-right")[0].innerHTML = "Once powered by Valine"
      }, 1000)
     }
   }
 </script></div><footer><p class="site-info"> 博客已萌萌哒运行<span id="time-to-now"></span><span class="my-face">(●'◡'●)ﾉ♥</span><br> Theme - <a target="_blank" href="https://github.com/dongyuanxin/theme-bmw">BMW</a> | Made With 💗 | Powered by GodBMW & hellflame<br></p></footer><script src="/js/footer.js"></script><script>updateUptime(2016,3,27)</script><div class="back-to-top hidden"><span><i class="iconfont icon-60"></i><span></span> %</span></div><script src="/js/component/back-to-top.js"></script></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script src="/js/mathjax.js"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.6/dist/jquery.fancybox.min.js" async></script><script async src="/js/fancybox.js"></script></body></html>