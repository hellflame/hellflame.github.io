<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><title>Qiniu Manager 开发记录 | Hellflame</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="diaries,python,shell,linux,"><meta name="description" content="pleased or sad, everything dies with hellflame"><link rel="alternate" href="/atom.xml" title="Hellflame" type="application/atom+xml"><link rel="icon" href="/images/favicon.png"><link rel="apple-touch-icon" href="/images/favicon.png"><link href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.6/dist/jquery.fancybox.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/base.css"><link rel="stylesheet" href="/icon/iconfont.css"><link rel="stylesheet" href="/css/github-markdown.css"><link rel="stylesheet" href="/css/highlight.css"><script src="/js/util.js"></script><script src="/js/valine.min.js"></script><link href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js" async></script><script src="/js/player.js"></script><link href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/leancloud-storage@3.11.0/dist/av-min.js"></script></head><body><div id="app"><div class="header-wrap"><header><div class="site-brand"><div class="site-title"> <a href="/">Hellflame</a></div></div><nav class="site-navigation"><ul class="nav-menu"><li class="nav-item" data-path="/"> <a href="/" target="_self">首页</a></li><li class="nav-item" data-path="/archives/"> <a href="/archives/" target="_self">归档</a></li><li class="nav-item" data-path="/categories/"> <a href="/categories/" target="_self">分类</a></li><li class="nav-item" data-path="/tags/"> <a href="/tags/" target="_self">标签</a></li><li class="nav-item" data-path="/friends/"> <a href="/friends/" target="_self">友链</a></li><li class="nav-item" data-path="/corner-story/"> <a href="/corner-story/" target="_self">转角杀</a></li><li class="nav-item" data-path="/about/"> <a href="/about/" target="_self">关于</a></li><li class="nav-item" data-path="https://github.com/hellflame"> <a href="https://github.com/hellflame" target="_self">Github</a></li></ul></nav><i class="iconfont icon-menu"></i></header></div><script src="/js/navigation.js"></script><div class="container post-index"><div class="post"><div style="position:fixed;right:1em;top:1.5em;cursor:pointer;z-index:999" onclick="toggleTOC()" id="toc"><div style="width:2em;height:2em"><div style="width:100%;height:3px;background:silver;margin-bottom:3px"></div><div style="width:100%;height:3px;background:silver;margin-bottom:3px"></div><div style="width:100%;height:3px;background:silver;margin-bottom:3px"></div></div></div><h1 class="article-title"> <span>Qiniu Manager 开发记录</span></h1><div class="article-top-meta"> <span>发布 : 2017-05-14</span> <span>分类 : <a href="/categories/diaries/">diaries</a></span> <span>浏览 : <span class="article-timer">--</span></span></div><div class="article-content"><div class="markdown-body"><p>GitHub项目地址：<a href="https://github.com/hellflame/qiniu_manager" target="_blank" rel="noopener">https://github.com/hellflame/qiniu_manager</a></p><p>具体使用方法：<a href="https://github.com/hellflame/qiniu_manager/blob/master/README.md" target="_blank" rel="noopener">参考</a></p><p>由于在GitHub上已经写的很清楚了，所以对于项目细节就不再赘述了，以下只是作为记录。</p><p>首先，整个事情还要从貌似大二之前的暑期结束之后的那个学期开始(嗯，应该就是大二的第一学期)。</p><p>在那个暑假，青传的服务器貌似都换成了Linux(一台CentOS、一台Ubuntu)，虽然都是老机器，而且重要的是那时候开始，青传的所有网站都基本上终于开始了重写，然而两台服务器貌似都运行了6年还是10年(具体时间已经忘了=。=)，硬盘也没有更换记录，之前的Windows系统已经崩溃过好几次了，每次都是重启之后就完事了。在同一个机房里，还运行着一台DNS服务器，windows，崩溃的几率比另外两台web服务器要小一点，当然这也十分说的通，毕竟web服务器每天要接收无数的设备访问，这台DNS服务器只需要提供整栋楼的服务就够了。总而言之，web服务器的硬盘岌岌可危，而且也才经历过一次大的硬盘故障导致数据丢失，所以需要经常把网站的重要数据备份到远端，由于手上只有这两台服务器可用，而且都年事已高，所以只能考虑备份到远端了。</p><p>最终选择了使用七牛的云存储。因为当年一直在用Python，SDK也就选择了<a href="https://github.com/qiniu/python-sdk" target="_blank" rel="noopener">python版本</a>，虽然官方文档的确挺差，但是基本的资源操作按照文档的指引，还是可以完成的，这也是第一个版本的qiniumanager。当年七牛还没有用户实名制，只要是注册的用户，都有免费的10G空间，10G下载流量，10w次请求。虽然服务器上跑着大概十几个项目，10G的存储空间还是够的，当然因为每个项目彼此都独立，所以脚本每小时执行一次，每次只备份1个网站，所以每个网站的备份周期是项目数量 x 1小时。</p><p>第一个版本在完成之后就直接去执行一个<code>py</code>文件。好吧，当时觉得使用Pypi是一件很复杂的事情，当年见过的英文文档可能也比较少，觉得要发布到pypi巨难，于是在服务器上crontab定期执行py文件的方法在青传使用了很久，直到后来第一次把<code>YoudaoDict</code>(有道词典)上传到Pypi，就觉得一切其实都很简单，于是准备好把<code>qiniumanager</code>也上传到了Pypi上。</p><p>在发布到Pypi之后，也出现了很多问题。个人项目中的可执行脚本名字叫<code>qiniu</code>，然而官方SDK也有一个可执行脚本，名字叫<code>qiniupy</code>(时至今日，我依然不知道这个py能用来干什么)。这就导致在终端输入<code>qini</code>然后使用tab之后，终端不能自然的空出一格，因为自动补全还找到了可选的<code>qiniupy</code>，此时，我就萌生了想要自己写一个不依赖官方SDK的程序了=。=当然，要解决这个问题只需要删除<code>qiniupy</code>这个文件就好了，虽然每次官方SDK更新都要删除一次就是了。</p><p>然而直到某一次更新官方SDK之后，在终端打印出了很多数组和消息，并且快速的挤满了scroll</p><p><img src="/images/qiniu-manager-dev-rec/qiniu-sdk-print-issue.png" alt=""></p><p>作为一个终端用户，当然不能容忍自己的终端被一堆无用信息遮挡了视野，在给官方提了issue之后的确改过来了，不过这也更确定了要自己独立调用接口的想法了=。=</p><p>当然，重写整个SDK应该是在腾讯实习期间，当时手上的事情做的比较快，周末也基本上在公司。在腾讯期间被各种大神熏陶，发现他们查看问题基本上都深入了源代码，所以自己也应该在造轮子上面造的更精密一些，于是决定应该从HTTP报文开始造轮子。于是整个项目决定自己用TCP连接手动发送HTTP报文，这样的话，只需要保证与服务器接口对接就好了，并且还能精确的获得进度条(重点是进度条，但是官方在这块貌似做的并不好)。</p><p>手动处理HTTP报文，讲真的确挺烦的=。=或者说，手动处理任何网际间的通信都存在互相不知道要发送多少信息的问题。</p><p>首先，当然不能将整个HTTP报文都接收下来，因为，自己并不知道HTTP报文会有多大，如何设置socket要recv多少字节呢，当然，也不能全部接收下来，万一服务器给我传了一个100G的游戏呢=。=</p><p>各种协议都有自己结束的约定(最近刚刚知道的有smtp协议表示邮件内容结束的<code>\r\n.\r\n</code>)，HTTP请求也是如此。在发送请求中，GET请求是最简单的。</p><p>GET请求，请求的参数和数据都在url中(<code>?xxx=yyy&amp;zzz=aaa</code>)，服务器只需要解析完URL就可以得到参数，其他信息在<code>Headers</code>中可以获得，一条<code>Header</code>以一个<code>\r\n</code>结尾，最终以一行<code>\r\n</code>作为整个请求的结束。</p><p>POST请求，并不妨碍利用GET的方法，将部分参数放在URL中，但POST请求允许将不方便放在URL中的数据放进body中。当然，一定要有一个Header，<code>Content-Length</code>来指出这个body有多长，否则服务器会以Header结束后的<code>\r\n</code>作为整个POST请求的结尾，默认Content-Length: 0。</p><p>在这些header的<code>\r\n</code>之间，存在某种web攻击方式，具体细节就不再展开了。</p><p>发送这些请求的确挺简单，因为自己知道自己要发送多少东西，用固定的格式发送就好了，然而服务器肯定也会发送消息过来，来告诉客户端某些消息。问题就来了，客户端要准备接收多少字符串呢？</p><p>就个人而言，知道的有两种传输方式，比较复杂的一种是分块传输(chunked)，另一种相对的就是整块传输(不知道有没有官方名字)了。</p><p>个人默认第一次recv，先接收1k数据，不排除某些请求会超过1k，比如有特别多的cookie，或者有特别多其他的Header。将这1k数据接收进一个<code>StringIO</code>，之所以放进一个StringIO缓存的话，是因为它可以通过readline来判断是否是一个<code>\r\n</code>，免去了自己写正则的麻烦，这样也方便将后续的内容拼接起来，一个get_value就好了。如果没有读到空白行，便继续接收1k，以此类推。可以判断的是只要读到空白行，Header部分就结束了，在里面一定有一个content-length，由此来判断接下来要读多少content。在最后一次读取header的recv中，从空白行开始，减去已经读到的content，content-length 减去这部分长度，就是要读取的整个HTTP响应的报文了。</p><p>对于chunked编码，在读取header部分和非chunked编码一样，但是对于实体内容，存在一些复杂的情况。尤其是在最后一次读取Header的时候，可能会出现读取的内容中有不完整的块、完整的一个块、多个块，还有多个块后结一个不完整的块(好吧，这么慢慢分析起来还是挺清晰的样子)。总之，由于在qiniu manager的开发过程中没有遇到过chunked编码，于是整个项目就完全没有考虑chunked编码了，直到什么时候qiniu准备升级了再说好了=。=毕竟，我还没有准备开发一个足以替代urllib或者requests的库。</p><p>以上，基本上就是整个项目的开发过程了。有更新之后再更细记录好了。</p></div></div><div class="copy-right"><div class="markdown-body"><blockquote> 本文作者 : hellflame<br> 原文链接 : <a href="">https://hellflame.github.io/2017/05/14/qiniu-manager-dev-rec/</a><br> 版权声明 : 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</blockquote></div></div><div class="social-share" style="margin-top:-2rem" data-wechat-qrcode-title="<p>微信扫一扫</p>" data-wechat-qrcode-helper="<p>微信右上角, 扫一扫分享</p>" data-sites="qzone, qq, weibo, facebook, twitter"> <span style="color:#6b7487;font-size:1.4rem">分享到:</span></div><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js" async></script><div class="article-footer"><div class="article-meta pull-left"><span><i class="iconfont icon-06tags"></i> 标签: <span class="span--tag"><a href="/tags/python/">#python</a></span> <span class="span--tag"><a href="/tags/shell/">#shell</a></span> <span class="span--tag"><a href="/tags/linux/">#linux</a></span></span></div><div class="article-meta pull-right"></div></div></div><aside id="sidebar"><p id="sidebar-header"></p><ol id="sidebar-toc"></ol></aside><script async>getTOC().length||$("#toc").remove()</script><nav class="post-navigation"><div class="nav-pre"><i class="iconfont icon-prev"></i> 上一篇: <a href="/2017/05/09/about-opensource/" target="_self">开源狂想(乱想)</a></div><div class="nav-next"> 下一篇: <a href="/2017/06/14/linux-bash-auto-complete/" target="_self">10种有用的Linux bash自动补全实例</a><i class="iconfont icon-next"></i></div></nav><a href="#comment" class="comment-anchor"></a><div class="comment-title"><i class="iconfont icon-footprint"></i> 留下足迹<i class="iconfont icon-footprint"></i></div> <a style="margin-bottom:1em;display:block;cursor:pointer" onclick="gotoComment()">通过issue留言</a><div id="vcomments"></div><script defer="defer">new Valine({el:"#vcomments",appId:"a",appKey:"b",notify:!1,verify:!1,avatar:"robohash",placeholder:"不填邮箱，网址, 也能收到回复哦♪(^∇^*)\n当然也不一定会回复-_-",path:getRealPath()})</script><script defer="defer">
   function gotoComment() {
    location.href = `https://github.com/hellflame/hellflame.github.io/issues/new?title=关于%0A“Qiniu%20Manager%20%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95”&body=%23%23%23%20[原文地址](https://hellflame.github.io/2017/05/14/qiniu-manager-dev-rec/)%0A%0A%23%23%23%20想说的话(问题/支持/异议)%20%20%0A%0A${document.getElementById('veditor').value}`
   }
   document.onreadystatechange = (e) => {
     if(document.readyState === 'complete') {
      setTimeout(() => {
        const target = document.getElementsByClassName("vsubmit vbtn")[0]
        target.outerHTML = target.outerHTML
        setTimeout(() => {
          document.getElementsByClassName("vsubmit vbtn")[0].addEventListener('click', gotoComment)
          console.log("event replaced")
        }, 1000)
        document.getElementsByClassName("power txt-right")[0].innerHTML = "Once powered by Valine"
      }, 1000)
     }
   }
 </script></div><footer><p class="site-info"> 博客已萌萌哒运行<span id="time-to-now"></span><span class="my-face">(●'◡'●)ﾉ♥</span><br> Theme - <a target="_blank" href="https://github.com/dongyuanxin/theme-bmw">BMW</a> | Made With 💗 | Powered by GodBMW & hellflame<br></p></footer><script src="/js/footer.js"></script><script>updateUptime(2016,3,27)</script><div class="back-to-top hidden"><span><i class="iconfont icon-60"></i><span></span> %</span></div><script src="/js/component/back-to-top.js"></script></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script src="/js/mathjax.js"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.6/dist/jquery.fancybox.min.js" async></script><script async src="/js/fancybox.js"></script></body></html>