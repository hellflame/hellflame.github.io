<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><title>é˜»å¡çš„Tornado | Hellflame</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="basics,python,"><meta name="description" content="pleased or sad, everything dies with hellflame"><link rel="alternate" href="/atom.xml" title="Hellflame" type="application/atom+xml"><link rel="icon" href="/images/favicon.png"><link rel="apple-touch-icon" href="/images/favicon.png"><link href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.6/dist/jquery.fancybox.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/base.css"><link rel="stylesheet" href="/icon/iconfont.css"><link rel="stylesheet" href="/css/github-markdown.css"><link rel="stylesheet" href="/css/highlight.css"><script src="/js/util.js"></script><script src="/js/valine.min.js"></script><link href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js" async></script><script src="/js/player.js"></script><link href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/leancloud-storage@3.11.0/dist/av-min.js"></script></head><body><div id="app"><div class="header-wrap"><header><div class="site-brand"><div class="site-title"> <a href="/">Hellflame</a></div></div><nav class="site-navigation"><ul class="nav-menu"><li class="nav-item" data-path="/"> <a href="/" target="_self">é¦–é¡µ</a></li><li class="nav-item" data-path="/archives/"> <a href="/archives/" target="_self">å½’æ¡£</a></li><li class="nav-item" data-path="/categories/"> <a href="/categories/" target="_self">åˆ†ç±»</a></li><li class="nav-item" data-path="/tags/"> <a href="/tags/" target="_self">æ ‡ç­¾</a></li><li class="nav-item" data-path="/friends/"> <a href="/friends/" target="_self">å‹é“¾</a></li><li class="nav-item" data-path="/corner-story/"> <a href="/corner-story/" target="_self">è½¬è§’æ€</a></li><li class="nav-item" data-path="/about/"> <a href="/about/" target="_self">å…³äº</a></li><li class="nav-item" data-path="https://github.com/hellflame"> <a href="https://github.com/hellflame" target="_self">Github</a></li></ul></nav><i class="iconfont icon-menu"></i></header></div><script src="/js/navigation.js"></script><div class="container post-index"><div class="post"><div style="position:fixed;right:1em;top:1.5em;cursor:pointer;z-index:999" onclick="toggleTOC()" id="toc"><div style="width:2em;height:2em"><div style="width:100%;height:3px;background:silver;margin-bottom:3px"></div><div style="width:100%;height:3px;background:silver;margin-bottom:3px"></div><div style="width:100%;height:3px;background:silver;margin-bottom:3px"></div></div></div><h1 class="article-title"> <span>é˜»å¡çš„Tornado</span></h1><div class="article-top-meta"> <span>å‘å¸ƒ : 2017-12-06</span> <span>åˆ†ç±» : <a href="/categories/basics/">basics</a></span> <span>æµè§ˆ : <span class="article-timer">--</span></span></div><div class="article-content"><div class="markdown-body"><p>python-tornado ç›¸å¯¹äºå…¶ä»–çš„ç½‘ç»œæ¡†æ¶ï¼Œæœ€ä¸ºäººçŸ¥çš„ç‰¹ç‚¹å°±æ˜¯å¼‚æ­¥ç½‘ç»œå’Œéé˜»å¡I/Oï¼Œä»¥åŠä»¥ç”¨åŒæ­¥çš„æ–¹å¼å†™å¼‚æ­¥çš„ä»£ç ç­‰<a href="http://www.tornadoweb.org/en/stable/" target="_blank" rel="noopener">Tornado</a> ã€‚ç„¶é¹…ï¼Œåœ¨æœ€è‡ªç„¶(ä¸åšç‰¹åˆ«å¤„ç†)çš„æƒ…å†µä¸‹ï¼ŒTornado å…¶å®æ˜¯é˜»å¡çš„ã€‚</p><p>å…ˆçœ‹ä¸€ä¸ªé˜»å¡çš„ä¾‹å­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tornado.ioloop</span><br><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.write(<span class="string">"index"</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Blocking</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        time.sleep(<span class="number">10</span>)</span><br><span class="line">        self.write(<span class="string">"blocking"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    tornado.web.Application(handlers=[</span><br><span class="line">        (<span class="string">'/'</span>, IndexHandler),</span><br><span class="line">        (<span class="string">'/blocking'</span>, Blocking)</span><br><span class="line">    ], autoreload=<span class="keyword">True</span>).listen(<span class="number">5000</span>, <span class="string">'localhost'</span>)</span><br><span class="line">    tornado.ioloop.IOLoop().current().start()</span><br></pre></td></tr></table></figure><p>å¦‚æœå…ˆè®¿é—® <code>localhost:5000/blocking</code>ï¼Œé‚£ä¹ˆåœ¨æ¥ä¸‹æ¥çš„10så†…å†è®¿é—® <code>localhost:5000</code> å°±ä¼šå‘ç°ä¸€ç›´æ²¡æœ‰ç›¸åº”ï¼Œä¸€ç›´åˆ°ç­‰åˆ° 10s ç»“æŸï¼Œå¤„ç†å®Œ <code>blocking</code> çš„è¯·æ±‚ã€‚(è™½ç„¶è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªæ­£ç¡®çš„ä¾‹å­ï¼Œä½†æ˜¯æ¥ä¸‹æ¥è®°å½•çš„æ­£æ˜¯å¯¹<code>åç¨‹</code>çš„è¿›ä¸€æ­¥ç†è§£)</p><p>é€šè¿‡å„æ–¹æœç´¢ï¼Œè‚¯å®šèƒ½å¤Ÿæ‰¾åˆ°ä¸‹é¢çš„æ–¹æ³•æ¥è§£å†³æ•´ä¸ªTornadoé˜»å¡åœ¨è¿™ä¸ªé˜»å¡è¯·æ±‚ä¸Š:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tornado.ioloop</span><br><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tornado <span class="keyword">import</span> gen</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.write(<span class="string">"index"</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Blocking</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line"><span class="meta">    @gen.coroutine</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># time.sleep(10)</span></span><br><span class="line">        <span class="keyword">yield</span> gen.sleep(<span class="number">10</span>)</span><br><span class="line">        self.write(<span class="string">"blocking"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    tornado.web.Application(handlers=[</span><br><span class="line">        (<span class="string">'/'</span>, IndexHandler),</span><br><span class="line">        (<span class="string">'/blocking'</span>, Blocking)</span><br><span class="line">    ], autoreload=<span class="keyword">True</span>).listen(<span class="number">5000</span>, <span class="string">'localhost'</span>)</span><br><span class="line">    tornado.ioloop.IOLoop().current().start()</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å†æ¬¡å…ˆè®¿é—® <code>localhost:5000/blocking</code> ï¼Œä¼šå‘ç°è®¿é—®è¿™ä¸ªè¯·æ±‚çš„æ—¶å€™ä¾ç„¶éœ€è¦ç­‰å¾…10sæ‰ä¼šæœ‰å“åº”ï¼Œç„¶è€Œä¸åŒçš„æ˜¯åœ¨è¿™æœŸé—´è®¿é—® <code>localhost:5000</code> å˜çš„å¾ˆé¡ºç•…ï¼Œå°±åƒç½‘ç«™ä¸Šæ²¡æœ‰ä»€ä¹ˆé˜»å¡çš„äº‹ä»¶åœ¨è¿è¡Œä¸€æ ·(å®é™…ä¸Šä¹Ÿå¹¶æ²¡æœ‰)ã€‚å¤§å¤šæ•°äººåœ¨è¿™é‡Œå°±å¼€å§‹ç¬ƒä¿¡tornadoä¸­å¼‚æ­¥çš„å¼ºå¤§ï¼Œä»¥åŠç”¨ <code>åç¨‹</code> å°†é˜»å¡å˜æˆéé˜»å¡çš„ä¸‡èƒ½(å°±åƒå½“å¹´çš„æˆ‘23333)ï¼Œå…¶å®è¿™é‡Œåªæ˜¯ç”¨é”™äº†æ —å­ã€‚ä¹‹æ‰€ä»¥è¯´ç”¨é”™ï¼Œæ˜¯å› ä¸º <code>gen.sleep</code> å¹¶ä¸æ˜¯å°†åŸæœ¬é˜»å¡çš„æ–¹æ³•å˜æˆäº†éé˜»å¡ï¼Œåªæ˜¯å·æ¢äº† <code>time.sleep</code> çš„åŒæ­¥æ€§ï¼Œå–è€Œä»£ä¹‹å»¶è¿Ÿæ‰§è¡Œçš„è¡¨è±¡ã€‚</p><p>æŸ¥çœ‹ä¸€ä¸‹ tornado ä¸­ <code>gen.sleep</code>ç©¶ç«Ÿåšäº†ä»€ä¹ˆï¼Œå°±ä¼šå‘ç°:</p><p><a href="https://github.com/tornadoweb/tornado/blob/5fcfb4277514ff82e2d3b17a24a26ed505b8d453/tornado/gen.py#L950" target="_blank" rel="noopener">gen.sleep æºç ç‰‡æ®µ</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sleep</span><span class="params">(duration)</span>:</span></span><br><span class="line">    <span class="string">"""Return a `.Future` that resolves after the given number of seconds.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    When used with ``yield`` in a coroutine, this is a non-blocking</span></span><br><span class="line"><span class="string">    analogue to `time.sleep` (which should not be used in coroutines</span></span><br><span class="line"><span class="string">    because it is blocking)::</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        yield gen.sleep(0.5)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Note that calling this function on its own does nothing; you must</span></span><br><span class="line"><span class="string">    wait on the `.Future` it returns (usually by yielding it).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. versionadded:: 4.1</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    f = Future()</span><br><span class="line">    IOLoop.current().call_later(duration, <span class="keyword">lambda</span>: f.set_result(<span class="keyword">None</span>))</span><br><span class="line">    <span class="keyword">return</span> f</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª <code>sleep</code> å¹¶æ²¡æœ‰çœŸçš„sleepï¼Œåªæ˜¯åœ¨äº‹ä»¶å¾ªç¯ä¸­æ·»åŠ äº†ä¸€ä¸ªå»¶è¿Ÿçš„å›è°ƒï¼Œå¦‚æœé‡åˆ°çœŸçš„éœ€è¦(è¿ç»­ä¸æ–­)å ç”¨ç‚’é¸¡é•¿æ—¶é—´çš„ä»»åŠ¡è¿è¡Œï¼Œæ•´ä¸ªç½‘ç«™ä¸€å®šä¼šé˜»å¡ã€‚å…¶å®ä»”ç»†æƒ³æƒ³ä¹Ÿå¹¶ä¸å›°éš¾ï¼Œå•å¼€ä¸€ä¸ªTornadoè¿›ç¨‹ï¼Œæ²¡æœ‰å¤šçº¿ç¨‹ï¼Œæ•´ä¸ªç½‘ç«™ä¹Ÿåªèƒ½åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹è¿è¡Œï¼Œå¦‚æœæŸä¸€ä¸ªä»»åŠ¡æ¯«æ— é—´æ–­åœ°åœ¨æ•´ä¸ªç½‘ç«™çš„æ—¶é—´ç‰‡ä¸Šè¿è¡Œï¼Œå½“ç„¶ä¼šé€ æˆé˜»å¡ã€‚äºæ˜¯ä¹ï¼Œæ¥ä¸‹æ¥èƒ½æƒ³åˆ°çš„å¤„ç†æ–¹æ³•å°±æ˜¯å¤šçº¿ç¨‹çš„æ–¹æ³•äº†ï¼Œtornadoä¹Ÿæ”¯æŒè¿™ç§æ–¹å¼å®ç°å¤šçº¿ç¨‹éé˜»å¡ã€‚ä¿®æ”¹ä¹‹åçš„ä»£ç å¯èƒ½ç±»ä¼¼è¿™æ ·:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tornado.ioloop</span><br><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> tornado.concurrent <span class="keyword">import</span> run_on_executor</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.write(<span class="string">"index"</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Blocking</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">    executor = ThreadPoolExecutor(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @run_on_executor</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        time.sleep(<span class="number">10</span>)</span><br><span class="line">        self.write(<span class="string">"blocking"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    tornado.web.Application(handlers=[</span><br><span class="line">        (<span class="string">'/'</span>, IndexHandler),</span><br><span class="line">        (<span class="string">'/blocking'</span>, Blocking)</span><br><span class="line">    ], autoreload=<span class="keyword">True</span>).listen(<span class="number">5000</span>, <span class="string">'localhost'</span>)</span><br><span class="line">    tornado.ioloop.IOLoop().current().start()</span><br></pre></td></tr></table></figure><p>å®Œå…¨ä¸éœ€è¦ tornado åç¨‹çš„æ”¯æŒï¼Œåªéœ€è¦ä¸€ä¸ªé¢å¤–çš„çº¿ç¨‹æ± å°±å¥½äº†ï¼Œè¿™æ ·ä¹Ÿèƒ½è¾¾åˆ°æ›¾ç»ç”¨åç¨‹æ—¶å€™çš„æ•ˆæœï¼Œè€Œä¸”è¿™æ¬¡æ˜¯çœŸçš„éé˜»å¡äº†ï¼Œæ¯•ç«Ÿé˜»å¡çš„ä»»åŠ¡è·‘åœ¨äº†å…¶ä»–çº¿ç¨‹ä¸Šã€‚è¿™é‡Œç”¨åˆ°äº†python2æ²¡æœ‰è‡ªå¸¦çš„ <code>concurrent</code> åº“ï¼Œpython2ä¸‹é¢éœ€è¦é¢å¤–å®‰è£…ã€‚ç„¶è€Œï¼ŒC Pythonä¸­çš„å¤šçº¿ç¨‹æ¶‰åŠåˆ°çš„GILä¾ç„¶ä¼šå¯¼è‡´ä¾èµ–è®¡ç®—èµ„æºçš„ä»»åŠ¡é˜»å¡æ•´ä¸ªè¿›ç¨‹ã€‚äºæ˜¯è¿˜ä¼šæœ‰æ›´å¤šåŸºäºæ¶ˆæ¯é˜Ÿåˆ—(æ¯”å¦‚ Celeryã€Redis)çš„æ–¹å¼ï¼Œåœ¨åˆ†å¸ƒå¼çš„ç¯å¢ƒä¸­å‡å°‘é˜»å¡çš„å‘ç”Ÿã€‚å½“ç„¶ï¼Œæˆ‘å¹¶ä¸ä¼šç»§ç»­æ²¿ç€è¿™æ¡è·¯èµ°ä¸‹å»äº†ï¼Œå¦‚æ­¤ä¸‹å»æ•´ä¸ªç½‘ç«™çš„ç¡®ä¼šè¡¨ç°ä¼˜å¼‚ï¼Œç„¶è€Œï¼Œå„ç§ç¨‹åºä¾èµ–ä¸ä»…ä¼šé™ä½å¯æ§æ€§ï¼Œæé«˜ç»´æŠ¤éš¾åº¦ï¼Œä¹Ÿå‡å°‘äº†æ€è€ƒçš„ä½™åœ°ã€‚</p><p>æœ€è¿‘å°±èµ°åˆ°äº†è¿™æ­¥ä½™åœ°ã€‚åˆšåˆšä¿®å¥½ä¸€ä¸ªé—®é¢˜ï¼Œåˆ°äº†åˆé¥­æ—¶é—´ï¼Œå°±çœ‹åˆ°è€å¤§çœ‰å¤´ç´§çš±çš„æ¥è·Ÿæˆ‘è¯´ï¼Œâ€æˆ‘å‘ç°äº†ä¸€ä¸ªå¾ˆå¤§çš„bugâ€ã€‚è¯è¿˜æ²¡è¯´å®Œï¼Œæˆ‘ä¹Ÿæ˜¯å¿ƒé‡Œä¸€ç´§ï¼Œéš¾é“æ˜¯æŠŠè‡ªå·±çš„æ¼æ´è¶Šä¿®è¶Šå¤§äº†å’©=ã€‚=ï¼Œâ€æˆ‘å‘ç°Tornadoæ˜¯é˜»å¡çš„â€ã€‚äºæ˜¯ä¹‹åæ‰èŠ±äº†æ—¶é—´ä¸€èµ·æ¢ç´¢äº†ä¸€ç•ªtornadoçš„åç¨‹å¼‚æ­¥ã€‚å°±åœ¨å‡†å¤‡ç”¨çº¿ç¨‹æ± æ¥æš‚æ—¶è§£å†³é—®é¢˜çš„æ—¶å€™ï¼Œå¿½ç„¶æƒ³èµ·æ¥åŒæ ·ç”¨åç¨‹æ¥è§£å†³é—®é¢˜çš„ <code>gevent</code> ï¼Œä¸­çš„ä¸€ä¸ªæ —å­:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey; monkey.patch_socket()</span><br><span class="line"><span class="keyword">import</span> gevent</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">        <span class="keyword">print</span> i</span><br><span class="line">        gevent.sleep(<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">gevent.joinall([gevent.spawn(f, <span class="number">5</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">5</span>)])</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æœ‰å…³é”®çš„ä¸€å¥ <code>gevent.sleep(0)</code>ï¼Œè¡¨é¢ä¸Šçœ‹æ¯«æ— ä½œç”¨(ç¡äº†0 s)ï¼Œç„¶è€Œå®é™…ä½œç”¨å´æ˜¯å…³é”®çš„ï¼Œèƒ½å¤Ÿè®©ä»»åŠ¡ä»åç¨‹ä¸­åˆ‡æ¢å‡ºæ¥ã€‚å†æƒ³æƒ³ä¸€èˆ¬å°†ç”Ÿæˆå™¨å½“ä½œåç¨‹æ¥ç”¨çš„æ—¶å€™é€šè¿‡ <code>yield</code> å°†åç¨‹åˆ‡æ¢å‡ºæ¥ï¼Œä»¥åŠ Tornado ä¸­çš„åç¨‹å¼‚æ­¥å…¶å®ä¹Ÿæ˜¯é€šè¿‡ <code>yield</code> è¿›è¡Œåç¨‹è°ƒåº¦ï¼Œé‚£ä¹ˆå†çœ‹çœ‹ <code>time.sleep(10)</code> ä¹‹æ‰€ä»¥åœ¨ä½¿ç”¨äº†ä¼ è¯´ä¸­çš„éé˜»å¡é­”æ³•ä¹‹åä¾ç„¶å‘ç”Ÿé˜»å¡ï¼Œå°±ä¼šå‘ç°ï¼ŒçœŸæ­£çš„åŸå› å…¶å®æ˜¯ <code>time.sleep(10)</code> è¿‡äºåºå¤§ï¼Œå¹¶ä¸”æ²¡æœ‰åç¨‹æ’æ‰‹è¿›è¡Œè°ƒåº¦çš„ä½™åœ°ã€‚æŠŠè¿™ä¸ªé˜»å¡çš„æ–¹æ³•æ¢æˆè¿™æ ·:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Blocking</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line"><span class="meta">    @gen.coroutine</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">            <span class="keyword">yield</span> time.sleep(<span class="number">0.01</span>)</span><br><span class="line">        self.write(<span class="string">"blocking"</span>)</span><br></pre></td></tr></table></figure><p>å°±ä¼šå‘ç°è™½ç„¶ä¹Ÿæ˜¯ç”¨çš„ <code>time.sleep</code> è¿™ä¸ªé˜»å¡æ–¹æ³•ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰é˜»å¡ç°è±¡(å› ä¸ºåªé˜»å¡äº†0.01så°±å»å“åº” <code>/</code>è·¯å¾„å»äº†)ã€‚å½“ç„¶ï¼Œè¿™æ˜¯æœ€ç®€å•çš„å°†é˜»å¡å˜æˆéé˜»å¡çš„æƒ…å†µï¼Œå®é™…ä¸Šè‚¯å®šä¼šåœ¨å…¶ä»–åœ°æ–¹å®Œæˆé€»è¾‘å“åº”ï¼Œå°†ç»“æœäº¤ç»™ tornadoå»å“åº”ç»™è¯·æ±‚ã€‚æ¯”å¦‚è¿™æ ·:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Blocking</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line"><span class="meta">    @gen.coroutine</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">yield</span> sleepy()</span><br><span class="line">        self.write(<span class="string">"blocking"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@gen.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sleepy</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">        <span class="keyword">yield</span> time.sleep(<span class="number">0.01</span>)</span><br></pre></td></tr></table></figure><p>ç„¶è€Œå¯¹äºæ¶ˆè€—CPUèµ„æº(è®¡ç®—å‹)çš„ä»»åŠ¡è€Œè¨€ï¼Œé¦–å…ˆèƒ½ä¸èƒ½æ‰¾åˆ°è¿™ä¸ªåç¨‹åˆ‡æ¢çš„ç‚¹å¾ˆéš¾è¯´ï¼Œç„¶åè¿™ä¸ªè®¡ç®—å‹çš„åç¨‹ä¼šä¸ä¼šè¢«åˆ‡æ¢æ›´æ˜¯å¦å¤–ä¸€å›äº‹ã€‚åç¨‹å¹¶ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œå†æ€ä¹ˆè¯´ä¹Ÿåªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¿è¡Œï¼Œå†åŠ ä¸Š python è¿è¡Œæ•ˆç‡çš„ä½ä¸‹ï¼Œå¤§å¤šæ•°äººæ²¡æœ‰åœç•™åœ¨åç¨‹ä¸Šè¿˜æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</p></div></div><div class="copy-right"><div class="markdown-body"><blockquote> æœ¬æ–‡ä½œè€… : hellflame<br> åŸæ–‡é“¾æ¥ : <a href="">https://hellflame.github.io/2017/12/06/block-tornado/</a><br> ç‰ˆæƒå£°æ˜ : æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</blockquote></div></div><div class="social-share" style="margin-top:-2rem" data-wechat-qrcode-title="<p>å¾®ä¿¡æ‰«ä¸€æ‰«</p>" data-wechat-qrcode-helper="<p>å¾®ä¿¡å³ä¸Šè§’, æ‰«ä¸€æ‰«åˆ†äº«</p>" data-sites="qzone, qq, weibo, facebook, twitter"> <span style="color:#6b7487;font-size:1.4rem">åˆ†äº«åˆ°:</span></div><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js" async></script><div class="article-footer"><div class="article-meta pull-left"><span><i class="iconfont icon-06tags"></i> æ ‡ç­¾: <span class="span--tag"><a href="/tags/python/">#python</a></span></span></div><div class="article-meta pull-right"></div></div></div><aside id="sidebar"><p id="sidebar-header"></p><ol id="sidebar-toc"></ol></aside><script async>getTOC().length||$("#toc").remove()</script><nav class="post-navigation"><div class="nav-pre"><i class="iconfont icon-prev"></i> ä¸Šä¸€ç¯‡: <a href="/2017/10/06/python-optimize/" target="_self">Python è°ƒä¼˜ç­–ç•¥</a></div><div class="nav-next"> ä¸‹ä¸€ç¯‡: <a href="/2018/12/31/2018-end/" target="_self">åœ¨å³å°†ç»“æŸçš„2018å¹´</a><i class="iconfont icon-next"></i></div></nav><a href="#comment" class="comment-anchor"></a><div class="comment-title"><i class="iconfont icon-footprint"></i> ç•™ä¸‹è¶³è¿¹<i class="iconfont icon-footprint"></i></div> <a style="margin-bottom:1em;display:block;cursor:pointer" onclick="gotoComment()">é€šè¿‡issueç•™è¨€</a><div id="vcomments"></div><script defer="defer">new Valine({el:"#vcomments",appId:"a",appKey:"b",notify:!1,verify:!1,avatar:"robohash",placeholder:"ä¸å¡«é‚®ç®±ï¼Œç½‘å€, ä¹Ÿèƒ½æ”¶åˆ°å›å¤å“¦â™ª(^âˆ‡^*)\nå½“ç„¶ä¹Ÿä¸ä¸€å®šä¼šå›å¤-_-",path:getRealPath()})</script><script defer="defer">
   function gotoComment() {
    location.href = `https://github.com/hellflame/hellflame.github.io/issues/new?title=å…³äº%0Aâ€œ%E9%98%BB%E5%A1%9E%E7%9A%84Tornadoâ€&body=%23%23%23%20[åŸæ–‡åœ°å€](https://hellflame.github.io/2017/12/06/block-tornado/)%0A%0A%23%23%23%20æƒ³è¯´çš„è¯(é—®é¢˜/æ”¯æŒ/å¼‚è®®)%20%20%0A%0A${document.getElementById('veditor').value}`
   }
   document.onreadystatechange = (e) => {
     if(document.readyState === 'complete') {
      setTimeout(() => {
        const target = document.getElementsByClassName("vsubmit vbtn")[0]
        target.outerHTML = target.outerHTML
        setTimeout(() => {
          document.getElementsByClassName("vsubmit vbtn")[0].addEventListener('click', gotoComment)
          console.log("event replaced")
        }, 1000)
        document.getElementsByClassName("power txt-right")[0].innerHTML = "Once powered by Valine"
      }, 1000)
     }
   }
 </script></div><footer><p class="site-info"> åšå®¢å·²èŒèŒå“’è¿è¡Œ<span id="time-to-now"></span><span class="my-face">(â—'â—¡'â—)ï¾‰â™¥</span><br> Theme - <a target="_blank" href="https://github.com/dongyuanxin/theme-bmw">BMW</a> | Made With ğŸ’— | Powered by GodBMW & hellflame<br></p></footer><script src="/js/footer.js"></script><script>updateUptime(2016,3,27)</script><div class="back-to-top hidden"><span><i class="iconfont icon-60"></i><span></span> %</span></div><script src="/js/component/back-to-top.js"></script></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script src="/js/mathjax.js"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.6/dist/jquery.fancybox.min.js" async></script><script async src="/js/fancybox.js"></script></body></html>